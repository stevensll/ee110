; utilities
 .include  "../inc/GeneralMacros.inc"
 .include  "../inc/GeneralConstants.inc"

; CC26x2 hardware
 .include  "inc/CPUreg.inc"
 .include  "inc/GPIOreg.inc"
 .include  "inc/IOCreg.inc"
 .include  "inc/GPTreg.inc"

; This program specific
 .include  "..inc/Keypad.inc"

    .text


    .def InitPower
    .def InitClocks
    .def InitGPIO
    .def InitGPT0
    
; InitPower
; Description:       Turn on the power to the peripherals. 
;
; Operation:         Setup PRCM registers to turn on power to the peripherals.
;
; Arguments:         None.
; Return Value:      None.
;
; Local Variables:   None.
; Shared Variables:  None.
; Global Variables:  None.
;
; Input:             None.
; Output:            None.
;
; Error Handling:    None.
;
; Algorithms:        None.
; Data Structures:   None.
;
; Registers Changed: flags, R0, R1
; Stack Depth:       0 words
;
; References:        CC26xR manual: Active mode: sec 7.6.2 (pg 519) 
;
; Revision History:  02/17/21   Glen George      initial revision
;                    10/30/25   Steven Lei       retrieved from Glen's website

InitPower:
        MOV32   R1, PRCM_BASE_ADDR              ;get base for power registers
        STREG   PD_PERIPH_EN, R1, PDCTL0_OFF    ;turn on peripheral power

WaitPowerOn:                                    ;wait for power on
        LDR     R0, [R1, #PDSTAT0_OFF]          ;get power status
        ANDS    R0, #PD_PERIPH_STAT             ;check if power is on
        BEQ     WaitPowerOn                     ;if not, keep checking
        ;BNE    DonePeriphPower                 ;otherwise done

DonePeriphPower:                                ;done turning on peripherals
        BX      LR


; InitClocks
;
; Description:       Turn on the clock to the peripherals. 
;
; Operation:         Setup PRCM registers to turn on clock to the peripherals.
;
; Arguments:         None.
; Return Value:      None.
;
; Local Variables:   None.
; Shared Variables:  None.
; Global Variables:  None.
;
; Input:             None.
; Output:            None.
;
; Error Handling:    None.
;
; Algorithms:        None.
; Data Structures:   None.
;
; Registers Changed: flags, R0, R1
; Stack Depth:       0 words
;
; References:        CC26xR manual: Clock gating, sec 7.5.2.1, pg 516 - 517
;   
; Revision History:  02/17/21   Glen George      initial revision
;                    10/30/25   Steven Lei       retrieved from Glen's website

InitClocks:


        MOV32   R1, PRCM_BASE_ADDR              ;get base for power registers

        STREG   GPIOCLK_EN, R1, GPIOCLKGR_OFF   ;turn on GPIO clocks
        STREG   GPT0CLK_EN, R1, GPTCLKGR_OFF    ;turn on Timer 0 clocks
        STREG   GPTCLKDIV_1, R1, GPTCLKDIV_OFF  ;timers get system clock

        STREG   CLKLOADCTL_LD, R1, CLKLOADCTL_OFF  ;load clock settings

WaitClocksLoaded:                               ;wait for clocks to be loaded
        LDR     R0, [R1, #CLKLOADCTL_OFF]       ;get clock status
        ANDS    R0, #CLKLOADCTL_STAT            ;check if clocks are on
        BEQ     WaitClocksLoaded                ;if not, keep checking
        ;BNE    DoneClockSetup                  ;otherwise done


DoneClockSetup:                                 ;done setting up clock
        BX      LR



; InitGPT0
;
; Description:       This function initializes GPT0.  It sets up the timer to
;                    generate interrupts every KEYPAD_INT_MS milliseconds.
;
; Operation:         The appropriate values are written to the timer control
;                    registers such that the Timer0A is configured to 32 bit,
;                    periodic mode with interrupts enabled. 
;
; Arguments:         None.
; Return Value:      None.
;
; Local Variables:   None.
; Shared Variables:  None.
; Global Variables:  None.
;
; Input:             None.
; Output:            None.
;
; Error Handling:    None.
;
; Algorithms:        None.
; Data Structures:   None.
;
; Registers Changed: R0, R1
; Stack Depth:       0 words
;
; References:        CC26xR manual: Periodic timer modes, sec 15.4.1 pg 1347
;
; Revision History:  02/17/21   Glen George      initial revision
;                    11/17/25   Steven Lei       retrieved from Glen's website
;                    11/17/25   Steven Lei       update procedure to reflect
;                                                steps in manual guide
InitGPT0:

GPT0AConfig:            ;configure timer 0A as a down counter generating
                        ;   interrupts every KEYPAD_INT_MS milliseconds

        MOV32   R1, GPT0_BASE_ADDR              ;get GPT0 base address
        STREG   GPT_CTL_TADIS, R1, GPT_CTL_OFF  ;disable timer A before changes
        STREG   GPT_CFG_32x1, R1, GPT_CFG_OFF   ;setup one 32-bit timer

        STREG   GPT_IRQ_TATO, R1, GPT_IMR_OFF   ;enable timeout interrupt
        STREG   GPT_TxMR_PERIODIC | GPT_TxCDIR_DOWN, R1, GPT_TAMR_OFF ;set timer mode to periodic
                                                ;set timer for 1 ms interrupt
        STREG   (KEYPAD_INT_MS * CLK_PER_MS), R1, GPT_TAILR_OFF
        STREG   GPT_TxPR_PRSCL_1, R1, GPT_TAPR_OFF ;set prescale to 1
        STREG   GPT_CTL_TAEN, R1, GPT_CTL_OFF   ;enable timer A with changes


        BX      LR                              ;done so return

; InitGPIO
;
; Description:       Initialize the I/O pins for the keypad. The keypad
;                    rows are written as outputs and the keypad rows are read
;                    as inputs.
;
; References:        keypad-schematic.pdf
;                    
;                    
; Operation:         Setup pins 20, 19, and 18 as inputs to read keypad cols.
;                    Setup pins 4 and 20 as outputs to write keypad rows.
;
; Arguments:         None.
; Return Value:      None.
;
; Local Variables:   None.
; Shared Variables:  None.
; Global Variables:  None.
;
; Input:             None.
; Output:            None.
;
; Error Handling:    None.
;
; Algorithms:        None.
; Data Structures:   None.
;
; Registers Changed: R0, R1
; Stack Depth:       0 words
;
; Revision History:  02/17/21   Glen George      initial revision
;                    10/28/25   Steven Lei       retrieved from website
;                    11/17/25   Steven Lei       update pinout for HW2 (keypad)

InitGPIO:

        MOV32   R1, IOC_BASE_ADDR       ;get base addr for I/O control registers
        MOV32   R0, IOCFG_GEN_DIN       ;setup for general inputs
        STR     R0, [R1, #IOCFG20]      ;write config for keypad column pin 0 
        STR     R0, [R1, #IOCFG19]      ;                               pin 1
        STR     R0, [R1, #IOCFG18]      ;                               pin 2

                                        ;R1 still has base addr for I/O control registers
        MOV32   R0, IOCFG_GEN_DOUT_4MA  ;setup for general 4mA outputs
        STR     R0, [R1, #IOCFG4]       ;write config for keypad demux pin a
        STR     R0, [R1, #IOCFG21]      ;                              pin b  
		STR		R0, [R1, #IOCFG5]		;				   interrupt test pin

        MOV32   R1, GPIO_BASE_ADDR      ;get base addr for GPIO pins
                                        ;and write enable for output pins
        STREG   ((1 << DEMUX_PIN_A) | (1 << DEMUX_PIN_B) | (1 << INT_TEST_PIN)), R1, GPIO_DOE31_0_OFF


        BX      LR                      ;done so return


